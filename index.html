<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Planner</title>

  <!-- Telegram WebApp SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root{
      --bg:#0b0f14; --card:#111826; --txt:#e6edf3; --mut:#9aa4b2; --acc:#3b82f6;
      --danger:#ef4444; --ok:#22c55e;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0; font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Inter,Arial,sans-serif;
      background:var(--bg); color:var(--txt);
    }
    .wrap{ padding:14px; max-width:860px; margin:0 auto; }
    .top{
      display:flex; gap:12px; align-items:center; justify-content:space-between; margin-bottom:12px;
    }
    .pill{
      background:var(--card); border:1px solid rgba(255,255,255,.08);
      padding:10px 12px; border-radius:14px; font-size:14px; color:var(--txt);
    }
    .btn{
      background:var(--acc); border:none; color:white; padding:10px 12px; border-radius:12px;
      font-weight:700; cursor:pointer;
    }
    .btn:disabled{ opacity:.55; cursor:not-allowed; }
    .ghost{
      background:transparent; border:1px solid rgba(255,255,255,.14); color:var(--txt);
    }

    .calHead{
      display:flex; align-items:center; justify-content:space-between; gap:10px; margin:10px 0 8px;
    }
    .monthTitle{ font-weight:800; font-size:16px; }
    .calNav{ display:flex; gap:8px; }

    .grid{ display:grid; grid-template-columns:repeat(7, 1fr); gap:8px; }
    .dow{ color:var(--mut); font-size:12px; text-align:center; padding:6px 0; user-select:none; }
    .day{
      background:var(--card); border:1px solid rgba(255,255,255,.08); border-radius:14px;
      padding:10px; min-height:64px; cursor:pointer; display:flex; flex-direction:column; gap:6px;
    }
    .day.muted{ opacity:.45; }
    .day.selected{ outline:2px solid rgba(59,130,246,.65); }
    .n{ font-weight:800; display:flex; justify-content:space-between; }
    .tag{ font-size:12px; color:var(--mut); }

    .panel{
      margin-top:12px; background:var(--card); border:1px solid rgba(255,255,255,.08);
      border-radius:16px; padding:12px;
    }
    .h{
      display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px;
      flex-wrap:wrap;
    }
    .hTitle{ font-weight:900; }
    .progress{ color:var(--mut); font-size:13px; }

    .row{ display:flex; gap:8px; margin-top:10px; }
    input{
      flex:1; background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.12);
      border-radius:12px; padding:10px 12px; color:var(--txt); outline:none;
    }
    .tasks{ margin-top:10px; display:flex; flex-direction:column; gap:8px; }
    .task{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      background:rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.08);
      border-radius:14px; padding:10px 12px;
    }
    .left{ display:flex; gap:10px; align-items:flex-start; }
    .cb{ width:18px; height:18px; margin-top:2px; }
    .ttext.done{ text-decoration:line-through; color:var(--mut); }
    .del{
      background:transparent; border:none; color:rgba(255,255,255,.65);
      cursor:pointer; font-size:18px; line-height:1;
    }
    .hint{ margin-top:10px; color:var(--mut); font-size:12px; }
    .danger{ color: var(--danger); }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="pill" id="userPill">Пользователь: Гость</div>
      <div style="display:flex; gap:8px;">
        <button class="btn ghost" id="prevDayBtn">←</button>
        <button class="btn ghost" id="nextDayBtn">→</button>
      </div>
    </div>

    <div class="panel">
      <div class="calHead">
        <div class="monthTitle" id="monthTitle">—</div>
        <div class="calNav">
          <button class="btn ghost" id="prevMonthBtn">← месяц</button>
          <button class="btn ghost" id="nextMonthBtn">месяц →</button>
        </div>
      </div>

      <div class="grid" id="dowRow"></div>
      <div class="grid" id="calGrid"></div>
    </div>

    <div class="panel">
      <div class="h">
        <div>
          <div class="hTitle" id="dayTitle">Выбери день</div>
          <div class="progress" id="progress">—</div>
        </div>
        <button class="btn ghost" id="rollBtn">Перенос невыполненного → завтра</button>
      </div>

      <div class="row">
        <input id="taskInput" placeholder="Новое дело…" />
        <button class="btn" id="addBtn">Добавить</button>
      </div>

      <div class="tasks" id="tasks"></div>

      <div class="hint">
        Совет: отметь выполненное галочкой. “Перенос” переносит только невыполненные.
        <span class="danger" id="err" style="display:none;"></span>
      </div>
    </div>
  </div>

<script>
  // ===== Telegram context =====
  const tg = window.Telegram?.WebApp;
  if (tg) tg.ready();

  const initData = tg?.initData || "";
  const user = tg?.initDataUnsafe?.user || null;
  const telegramId = user?.id ? String(user.id) : "guest";
  const userName = user ? (user.username ? "@"+user.username : [user.first_name, user.last_name].filter(Boolean).join(" ")) : "Гость";
  document.getElementById("userPill").textContent = "Пользователь: " + userName;

  // ===== State =====
  const LS_KEY = "planner_selected_date_v1";
  const DOW = ["Пн","Вт","Ср","Чт","Пт","Сб","Вс"];

  let selectedDate = loadSelectedDate() || todayLocal();
  let currentMonth = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), 1);

  let tasks = []; // [{text:string, done:boolean}]
  let isLoading = false;

  // ===== Helpers =====
  function pad(n){ return String(n).padStart(2,"0"); }
  function fmtISO(d){
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
  }
  function parseISO(s){
    const [y,m,dd] = s.split("-").map(Number);
    return new Date(y, (m-1), dd);
  }
  function todayLocal(){
    const now = new Date();
    return new Date(now.getFullYear(), now.getMonth(), now.getDate());
  }
  function addDays(date, delta){
    const d = new Date(date.getFullYear(), date.getMonth(), date.getDate());
    d.setDate(d.getDate() + delta);
    return d;
  }
  function monthName(d){
    return d.toLocaleDateString("ru-RU", { month:"long", year:"numeric" });
  }
  function dayTitle(d){
    return d.toLocaleDateString("ru-RU", { weekday:"long", day:"2-digit", month:"long" });
  }
  function saveSelectedDate(d){
    localStorage.setItem(LS_KEY, fmtISO(d));
  }
  function loadSelectedDate(){
    const s = localStorage.getItem(LS_KEY);
    if (!s) return null;
    try { return parseISO(s); } catch { return null; }
  }
  function setError(msg){
    const el = document.getElementById("err");
    if (!msg){ el.style.display="none"; el.textContent=""; return; }
    el.style.display="inline"; el.textContent=" — " + msg;
  }

  // ===== API =====
  async function api(action, dateISO, tasksArr){
    const res = await fetch("/.netlify/functions/tasks", {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({
        initData,
        telegramId,
        action,
        date: dateISO,
        tasks: tasksArr
      })
    });
    const data = await res.json().catch(()=> ({}));
    if (!res.ok) throw new Error(data?.error || "API error");
    return data;
  }

  async function loadTasksForDate(d){
    if (telegramId === "guest"){
      // режим без Telegram пользователя: локально
      const key = "planner_guest_" + fmtISO(d);
      tasks = JSON.parse(localStorage.getItem(key) || "[]");
      renderTasks();
      return;
    }

    isLoading = true;
    setError("");
    try{
      const data = await api("get", fmtISO(d));
      tasks = Array.isArray(data.tasks) ? data.tasks : [];
    }catch(e){
      setError(e.message || "Ошибка загрузки");
      tasks = [];
    }finally{
      isLoading = false;
      renderTasks();
    }
  }

  async function saveTasksForDate(d){
    if (telegramId === "guest"){
      const key = "planner_guest_" + fmtISO(d);
      localStorage.setItem(key, JSON.stringify(tasks));
      return;
    }
    setError("");
    await api("save", fmtISO(d), tasks);
  }

  // ===== UI: Calendar =====
  function renderDow(){
    const row = document.getElementById("dowRow");
    row.innerHTML = "";
    for (const name of DOW){
      const div = document.createElement("div");
      div.className = "dow";
      div.textContent = name;
      row.appendChild(div);
    }
  }

  function renderCalendar(){
    document.getElementById("monthTitle").textContent = capitalize(monthName(currentMonth));

    const grid = document.getElementById("calGrid");
    grid.innerHTML = "";

    const first = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), 1);
    // JS: 0=Sun..6=Sat; нам надо Пн=0..Вс=6
    let jsDow = first.getDay(); // 0..6
    let offset = (jsDow === 0) ? 6 : (jsDow - 1); // Пн=0

    const start = new Date(first);
    start.setDate(first.getDate() - offset);

    for (let i=0;i<42;i++){
      const d = new Date(start);
      d.setDate(start.getDate() + i);

      const cell = document.createElement("div");
      cell.className = "day";

      const isOtherMonth = d.getMonth() !== currentMonth.getMonth();
      if (isOtherMonth) cell.classList.add("muted");

      const isSelected = fmtISO(d) === fmtISO(selectedDate);
      if (isSelected) cell.classList.add("selected");

      const n = document.createElement("div");
      n.className = "n";
      n.innerHTML = `<span>${d.getDate()}</span><span class="tag">${(fmtISO(d)===fmtISO(todayLocal())) ? "сегодня" : ""}</span>`;

      cell.appendChild(n);

      cell.addEventListener("click", () => {
        selectDate(d);
      });

      grid.appendChild(cell);
    }
  }

  function capitalize(s){
    return s ? s.charAt(0).toUpperCase() + s.slice(1) : s;
  }

  // ===== UI: Tasks =====
  function renderTasks(){
    document.getElementById("dayTitle").textContent = dayTitle(selectedDate);
    const done = tasks.filter(t=>t.done).length;
    const total = tasks.length;
    document.getElementById("progress").textContent = total ? `Выполнено: ${done}/${total}` : "Пока нет дел на этот день.";

    const list = document.getElementById("tasks");
    list.innerHTML = "";

    tasks.forEach((t, idx) => {
      const row = document.createElement("div");
      row.className = "task";

      const left = document.createElement("div");
      left.className = "left";

      const cb = document.createElement("input");
      cb.type = "checkbox";
      cb.className = "cb";
      cb.checked = !!t.done;

      const text = document.createElement("div");
      text.className = "ttext" + (t.done ? " done" : "");
      text.textContent = t.text;

      cb.addEventListener("change", async () => {
        t.done = cb.checked;
        renderTasks();
        try{ await saveTasksForDate(selectedDate); }catch(e){ setError(e.message); }
      });

      const del = document.createElement("button");
      del.className = "del";
      del.textContent = "✕";
      del.addEventListener("click", async () => {
        tasks.splice(idx, 1);
        renderTasks();
        try{ await saveTasksForDate(selectedDate); }catch(e){ setError(e.message); }
      });

      left.appendChild(cb);
      left.appendChild(text);

      row.appendChild(left);
      row.appendChild(del);
      list.appendChild(row);
    });
  }

  async function addTask(){
    const inp = document.getElementById("taskInput");
    const text = (inp.value || "").trim();
    if (!text) return;
    tasks.unshift({ text, done:false });
    inp.value = "";
    renderTasks();
    try{ await saveTasksForDate(selectedDate); }catch(e){ setError(e.message); }
  }

  async function rollOverIncomplete(){
    const move = tasks.filter(t => !t.done).map(t => ({...t, done:false}));
    if (!move.length) return;

    // очистить текущий день от невыполненных (оставить выполненные)
    tasks = tasks.filter(t => t.done);
    renderTasks();

    const tomorrow = addDays(selectedDate, 1);

    try{
      // сохранить текущий день
      await saveTasksForDate(selectedDate);

      // загрузить завтра, добавить и сохранить
      const oldSelected = selectedDate;
      selectedDate = tomorrow;
      saveSelectedDate(selectedDate);

      await loadTasksForDate(selectedDate);
      tasks = [...move, ...tasks];
      renderTasks();
      await saveTasksForDate(selectedDate);

      // вернуть обратно на исходный день? (логичнее остаться на завтра)
      // если хочешь оставаться на старом — раскомментируй:
      // selectedDate = oldSelected;
      // saveSelectedDate(selectedDate);
      // await loadTasksForDate(selectedDate);

      // обновить календарь выделением
      currentMonth = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), 1);
      renderCalendar();
    }catch(e){
      setError(e.message || "Ошибка переноса");
    }
  }

  // ===== Navigation =====
  function selectDate(d){
    selectedDate = new Date(d.getFullYear(), d.getMonth(), d.getDate());
    saveSelectedDate(selectedDate);

    // если выбранная дата в другом месяце — перелистнём месяц
    currentMonth = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), 1);

    renderCalendar();
    loadTasksForDate(selectedDate);
  }

  document.getElementById("prevDayBtn").addEventListener("click", () => selectDate(addDays(selectedDate, -1)));
  document.getElementById("nextDayBtn").addEventListener("click", () => selectDate(addDays(selectedDate,  1)));

  document.getElementById("prevMonthBtn").addEventListener("click", () => {
    currentMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth()-1, 1);
    renderCalendar();
  });
  document.getElementById("nextMonthBtn").addEventListener("click", () => {
    currentMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth()+1, 1);
    renderCalendar();
  });

  document.getElementById("addBtn").addEventListener("click", addTask);
  document.getElementById("taskInput").addEventListener("keydown", (e)=>{ if(e.key==="Enter") addTask(); });
  document.getElementById("rollBtn").addEventListener("click", rollOverIncomplete);

  // ===== Init =====
  renderDow();
  renderCalendar();
  loadTasksForDate(selectedDate);
</script>
</body>
</html>
