<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Planner</title>
  <style>
    :root { --bg:#0b0f14; --card:#111826; --txt:#e6edf3; --mut:#9aa4b2; --acc:#3b82f6; }
    body { margin:0; font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Inter,Arial,sans-serif; background:var(--bg); color:var(--txt); }
    .wrap{ padding:14px; max-width:820px; margin:0 auto; }
    .top{ display:flex; gap:12px; align-items:center; justify-content:space-between; margin-bottom:12px; }
    .pill{ background:var(--card); border:1px solid rgba(255,255,255,.08); padding:10px 12px; border-radius:14px; }
    .btn{ background:var(--acc); border:none; color:white; padding:10px 12px; border-radius:12px; font-weight:600; cursor:pointer; }
    .ghost{ background:transparent; border:1px solid rgba(255,255,255,.14); color:var(--txt); }
    .grid{ display:grid; grid-template-columns:repeat(7,1fr); gap:8px; }
    .dow{ color:var(--mut); font-size:12px; text-align:center; padding:6px 0; }
    .day{ background:var(--card); border:1px solid rgba(255,255,255,.08); border-radius:14px; padding:10px; min-height:72px; cursor:pointer; display:flex; flex-direction:column; gap:6px; }
    .day.selected{ outline:2px solid rgba(59,130,246,.65); }
    .n{ font-weight:800; display:flex; justify-content:space-between; }
    .tag{ font-size:12px; color:var(--mut); }
    .panel{ margin-top:12px; background:var(--card); border:1px solid rgba(255,255,255,.08); border-radius:16px; padding:12px; }
    .h{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px; }
    .progress{ color:var(--mut); font-size:13px; }
    .row{ display:flex; gap:8px; margin-top:10px; }
    input{ flex:1; background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.12); border-radius:12px; padding:10px 12px; color:var(--txt); outline:none; }
    .tasks{ margin-top:10px; display:flex; flex-direction:column; gap:8px; }
    .task{ display:flex; align-items:center; justify-content:space-between; gap:10px; background:rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.08); border-radius:14px; padding:10px 12px; }
    .left{ display:flex; gap:10px; align-items:flex-start; }
    .cb{ width:18px; height:18px; margin-top:2px; }
    .ttext.done{ text-decoration:line-through; color:var(--mut); }
    .del{ background:transparent; border:none; color:rgba(255,255,255,.55); cursor:pointer; font-size:18px; }
  </style>
</head>
<body>
<div class="wrap">
  <div class="top">
    <div class="pill" id="who">Пользователь: …</div>
    <div class="pill" style="display:flex; gap:8px; align-items:center;">
      <button class="btn ghost" id="prev">←</button>
      <div id="month" style="font-weight:800; min-width:140px; text-align:center;"></div>
      <button class="btn ghost" id="next">→</button>
    </div>
  </div>

  <div class="grid" id="dow"></div>
  <div class="grid" id="cal"></div>

  <div class="panel">
    <div class="h">
      <h2 id="dayTitle">Выбери день</h2>
      <div class="progress" id="dayProgress">—</div>
    </div>

    <div class="row" id="addRow" style="display:none;">
      <input id="taskInput" placeholder="Напиши дело и нажми Добавить" maxlength="120" />
      <button class="btn" id="addBtn">Добавить</button>
    </div>

    <div class="tasks" id="tasks"></div>
    <div class="progress" id="empty" style="display:none;">Пока нет дел на этот день.</div>
  </div>
</div>

<script src="https://unpkg.com/@twa-dev/sdk@1.5.0/dist/index.umd.js"></script>
<script>
  const tg = window.Telegram?.WebApp;
  if (tg) { tg.ready(); tg.expand(); }

  const initData = tg?.initData || "";
  const user = tg?.initDataUnsafe?.user;
  const telegramId = user?.id ? String(user.id) : "guest";
  const uname = user ? [user.first_name, user.last_name].filter(Boolean).join(" ") : "Гость";

  document.getElementById("who").textContent = `Пользователь: ${uname}`;

  // API helper (Netlify Function)
  async function api(path, method="GET", body=null) {
    const res = await fetch(`/.netlify/functions/${path}`, {
      method,
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ initData, telegramId, ...body })
    });
    const data = await res.json().catch(() => ({}));
    if (!res.ok) throw new Error(data.error || "API error");
    return data;
  }

  // date helpers
  const pad2 = n => String(n).padStart(2,"0");
  const ymd = d => `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
  const human = d => `${d.getDate()} ${["янв","фев","мар","апр","май","июн","июл","авг","сен","окт","ноя","дек"][d.getMonth()]} ${d.getFullYear()}`;
  const monthTitle = d => `${["Январь","Февраль","Март","Апрель","Май","Июнь","Июль","Август","Сентябрь","Октябрь","Ноябрь","Декабрь"][d.getMonth()]} ${d.getFullYear()}`;

  // UI refs
  const calEl = document.getElementById("cal");
  const monthEl = document.getElementById("month");
  const prevBtn = document.getElementById("prev");
  const nextBtn = document.getElementById("next");
  const dayTitle = document.getElementById("dayTitle");
  const dayProgress = document.getElementById("dayProgress");
  const tasksEl = document.getElementById("tasks");
  const emptyEl = document.getElementById("empty");
  const addRow = document.getElementById("addRow");
  const taskInput = document.getElementById("taskInput");
  const addBtn = document.getElementById("addBtn");

  // DOW
  const dow = ["Пн","Вт","Ср","Чт","Пт","Сб","Вс"];
  document.getElementById("dow").innerHTML = dow.map(x => `<div class="dow">${x}</div>`).join("");

  let view = new Date(); view.setDate(1);
  let selectedDate = ymd(new Date());

  let cacheMonth = {}; // date -> {done,total,star}

  async function loadMonthSummary() {
    const month = `${view.getFullYear()}-${pad2(view.getMonth()+1)}`;
    const data = await api("month", "POST", { month });
    cacheMonth = data.summary || {};
  }

  async function loadDayTasks(dateKey) {
    const data = await api("day", "POST", { date: dateKey });
    return data.tasks || [];
  }

  function renderCalendar(){
    calEl.innerHTML = "";
    monthEl.textContent = monthTitle(view);

    const first = new Date(view.getFullYear(), view.getMonth(), 1);
    let startDow = first.getDay(); if (startDow === 0) startDow = 7;
    const pad = startDow - 1;
    const daysInMonth = new Date(view.getFullYear(), view.getMonth()+1, 0).getDate();

    for (let i=0;i<pad;i++){ const cell=document.createElement("div"); cell.style.visibility="hidden"; calEl.appendChild(cell); }

    for (let day=1; day<=daysInMonth; day++){
      const d = new Date(view.getFullYear(), view.getMonth(), day);
      const key = ymd(d);
      const sum = cacheMonth[key] || {done:0,total:0,star:false};

      const cell = document.createElement("div");
      cell.className = "day" + (selectedDate===key ? " selected" : "");
      cell.innerHTML = `
        <div class="n"><span>${day}</span><span>${sum.star ? "⭐" : ""}</span></div>
        <div class="tag">${sum.total>0 ? `${sum.done}/${sum.total}` : ""}</div>
      `;
      cell.onclick = async () => { selectedDate = key; renderCalendar(); await renderDay(key); };
      calEl.appendChild(cell);
    }
  }

  async function renderDay(dateKey){
    addRow.style.display = "flex";
    dayTitle.textContent = human(new Date(dateKey+"T00:00:00"));

    const list = await loadDayTasks(dateKey);
    const done = list.filter(x=>x.is_done).length;
    const total = list.length;
    dayProgress.textContent = `${done}/${total}`;

    tasksEl.innerHTML = "";
    emptyEl.style.display = total===0 ? "block" : "none";

    list.forEach(item => {
      const row = document.createElement("div");
      row.className = "task";
      row.innerHTML = `
        <div class="left">
          <input class="cb" type="checkbox" ${item.is_done ? "checked" : ""}/>
          <div class="ttext ${item.is_done ? "done":""}"></div>
        </div>
        <button class="del" title="Удалить">×</button>
      `;
      row.querySelector(".ttext").textContent = item.text;

      row.querySelector(".cb").onchange = async (e) => {
        await api("toggle", "POST", { id: item.id, is_done: !!e.target.checked });
        await refresh();
      };

      row.querySelector(".del").onclick = async () => {
        await api("delete", "POST", { id: item.id });
        await refresh();
      };

      tasksEl.appendChild(row);
    });
  }

  addBtn.onclick = async () => {
    const text = (taskInput.value||"").trim();
    if (!text) return;
    await api("add", "POST", { date: selectedDate, text });
    taskInput.value = "";
    await refresh();
  };

  async function refresh(){
    await loadMonthSummary();
    renderCalendar();
    await renderDay(selectedDate);
  }

  prevBtn.onclick = async () => { view = new Date(view.getFullYear(), view.getMonth()-1, 1); await refresh(); };
  nextBtn.onclick = async () => { view = new Date(view.getFullYear(), view.getMonth()+1, 1); await refresh(); };

  (async () => {
    await refresh();
  })();
</script>
</body>
</html>
